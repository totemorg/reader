'use strict';
Object.defineProperty(exports, "__esModule", { value: true });
const mod_1 = require("../mod");
const DIRECTIONS_REGEXP = /^[東西南北东]+$/;
/**
 * 词典优化模块
 *
 * @author 老雷<leizongmin@gmail.com>
 */
class DictOptimizer extends mod_1.SubSModuleOptimizer {
    constructor() {
        super(...arguments);
        this.name = 'DictOptimizer';
    }
    _cache() {
        super._cache();
        this._TABLE = this.segment.getDict('TABLE');
        this._POSTAG = this.segment.POSTAG;
    }
    isMergeable(w1, w2, { POSTAG, TABLE, nw, i, nw_cache, nw_cache_exists, }) {
        let bool;
        let m;
        /**
         * 原始判斷模式
         */
        if (w1.p == w2.p) {
            bool = true;
        }
        /**
         * 不確定沒有BUG 但原始模式已經不合需求 因為單一項目多個詞性
         */
        else if (m = (w1.p & w2.p)) {
            if (1 || m & POSTAG.D_N) {
                bool = true;
            }
        }
        /**
         * 允許例如 幾 + ％
         */
        else if (w1.p && typeof w2.p == 'undefined') {
            bool = true;
        }
        else if (w1.p & POSTAG.D_D && w2.p & POSTAG.D_V) {
            ({
                nw_cache,
                nw_cache_exists,
            } = this._getWordCache(nw, nw_cache, nw_cache_exists));
            let mw = nw_cache;
            if (mw && (mw.p & POSTAG.D_D || mw.p & POSTAG.D_V)) {
                bool = true;
            }
        }
        return bool
            && this._getWordCache(nw, nw_cache, nw_cache_exists).nw_cache_exists;
    }
    _getWordCache(nw, nw_cache, nw_cache_exists) {
        if (typeof nw_cache_exists === 'undefined') {
            const TABLE = this._TABLE;
            nw_cache = nw_cache || TABLE[nw];
            nw_cache_exists = !!nw_cache;
        }
        return {
            nw,
            nw_cache,
            nw_cache_exists,
        };
    }
    /**
     * 词典优化
     *
     * @param {array} words 单词数组
     * @param {bool} is_not_first 是否为管理器调用的
     * @return {array}
     */
    doOptimize(words, is_not_first) {
        //debug(words);
        if (typeof is_not_first == 'undefined') {
            is_not_first = false;
        }
        // 合并相邻的能组成一个单词的两个词
        const TABLE = this._TABLE;
        const POSTAG = this._POSTAG;
        const self = this;
        let i = 0;
        let ie = words.length - 1;
        while (i < ie) {
            let w1 = words[i];
            let w2 = words[i + 1];
            //debug(w1.w + ', ' + w2.w);
            // ==========================================
            let nw = w1.w + w2.w;
            let nw_cache;
            let nw_cache_exists;
            /**
             * 形容词 + 助词 = 形容词，如： 不同 + 的 = 不同的
             */
            if (w1.w != '了'
                && (w1.p & POSTAG.D_A)
                && (w2.p & POSTAG.D_U)) {
                let p = POSTAG.D_A;
                let f;
                ({
                    nw_cache,
                    nw_cache_exists,
                } = self._getWordCache(nw, nw_cache, nw_cache_exists));
                let mw = nw_cache;
                if (!mw || (mw.p & POSTAG.D_A)) {
                    if (mw && (mw.p & POSTAG.D_A)) {
                        p = mw.p;
                        f = mw.f;
                    }
                    else if (w1.p & POSTAG.BAD) {
                        p = POSTAG.D_A + POSTAG.BAD;
                    }
                    this.sliceToken(words, i, 2, {
                        w: nw,
                        //p: ((nw in TABLE && TABLE[nw].p & POSTAG.D_A) ? TABLE[nw].p : POSTAG.D_A),
                        p,
                        f,
                        m: [w1, w2],
                    }, undefined, {
                        [this.name]: 1,
                    });
                    ie--;
                    continue;
                }
            }
            /**
             * 形容詞 + 名詞 = 名詞
             */
            if ((w1.p & POSTAG.D_A)
                && (w2.p & POSTAG.D_N)) {
                ({
                    nw_cache,
                    nw_cache_exists,
                } = self._getWordCache(nw, nw_cache, nw_cache_exists));
                if (nw_cache_exists) {
                    let mw = nw_cache;
                    if (mw.p & POSTAG.D_N) {
                        this.sliceToken(words, i, 2, {
                            w: nw,
                            p: mw.p,
                            f: mw.f,
                            m: [w1, w2],
                        }, undefined, {
                            [this.name]: 7,
                        });
                        ie--;
                        continue;
                    }
                }
            }
            // 能组成一个新词的(词性必须相同)
            if (this.isMergeable(w1, w2, {
                nw,
                POSTAG,
                TABLE,
                i,
                nw_cache,
                nw_cache_exists,
            })) 
            //if (w1.p == w2.p && nw in TABLE)
            {
                ({
                    nw_cache,
                    nw_cache_exists,
                } = self._getWordCache(nw, nw_cache, nw_cache_exists));
                let mw = nw_cache;
                this.sliceToken(words, i, 2, {
                    w: nw,
                    p: mw.p,
                    f: mw.f,
                    m: [w1, w2],
                }, undefined, {
                    [this.name]: 2,
                });
                ie--;
                continue;
            }
            // ============================================
            // 数词组合
            if ((w1.p & POSTAG.A_M)) {
                //debug(w2.w + ' ' + (w2.p & POSTAG.A_M));
                // 百分比数字 如 10%，或者下一个词也是数词，则合并
                if ((w2.p & POSTAG.A_M
                    && !/^第/.test(w2.w)) || w2.w == '%' || w2.w == '％') {
                    this.sliceToken(words, i, 2, {
                        w: w1.w + w2.w,
                        p: POSTAG.A_M,
                        m: [w1, w2],
                    }, undefined, {
                        [this.name]: 3,
                    });
                    ie--;
                    continue;
                }
                // 数词 + 量词，合并。如： 100个
                if ((w2.p & POSTAG.A_Q)) {
                    // 数量词
                    let p = POSTAG.D_MQ;
                    let nw = w1.w + w2.w;
                    ({
                        nw_cache,
                        nw_cache_exists,
                    } = self._getWordCache(nw, nw_cache, nw_cache_exists));
                    if (nw_cache) {
                        p = nw_cache.p | POSTAG.D_MQ;
                    }
                    else {
                        if (w2.p & POSTAG.D_T) {
                            p = p | POSTAG.D_T;
                        }
                        if (w2.p & POSTAG.D_N) {
                            p = p | POSTAG.D_N;
                        }
                        if (w2.p & POSTAG.D_V) {
                            p = p | POSTAG.D_V;
                        }
                    }
                    this.sliceToken(words, i, 2, {
                        w: nw,
                        p,
                        m: [w1, w2],
                    }, undefined, {
                        [this.name]: 4,
                    });
                    ie--;
                    continue;
                }
                // 带小数点的数字 ，如 “3 . 14”，或者 “十五点三”
                // 数词 + "分之" + 数词，如“五十分之一”
                let w3 = words[i + 2];
                if (w3 && (w3.p & POSTAG.A_M)) {
                    if (w2.w == '.'
                        || w2.w == '点'
                        || w2.w == '點'
                        || w2.w == '分之') {
                        this.sliceToken(words, i, 3, {
                            w: w1.w + w2.w + w3.w,
                            p: POSTAG.A_M,
                            m: [w1, w2, w3],
                        }, undefined, {
                            [this.name]: 5,
                        });
                        ie -= 2;
                        continue;
                    }
                    /**
                     * 支援 `最多容納59,000個人,或5.9萬人,再多就不行了.這是環評的結論.`
                     */
                    if (w2.w == ',') {
                        let _r1 = /^[\d０-９]+$/;
                        let _r2 = /^(?:(?:[\d０-９]+)?(?:\.[\d０-９]+)|(?:[\d０-９]+))$/;
                        if (_r1.test(w1.w) && _r2.test(w3.w)) {
                            this.sliceToken(words, i, 3, {
                                w: w1.w + w2.w + w3.w,
                                p: POSTAG.A_M,
                                m: [w1, w2, w3],
                            }, undefined, {
                                [this.name]: 6,
                            });
                            ie -= 2;
                            continue;
                        }
                    }
                }
            }
            // 修正 “十五点五八”问题
            if ((w1.p & POSTAG.D_MQ) && ['點', '点'].includes(w1.w.substr(-1)) && w2.p & POSTAG.A_M) {
                //debug(w1, w2);
                let i2 = 2;
                let w4w = '';
                for (let j = i + i2; j < ie; j++) {
                    let w3 = words[j];
                    if ((w3.p & POSTAG.A_M) > 0) {
                        w4w += w3.w;
                        i2++;
                    }
                    else {
                        break;
                    }
                }
                this.sliceToken(words, i, i2, {
                    w: w1.w + w2.w + w4w,
                    p: POSTAG.D_MQ,
                    m: [w1, w2, w4w],
                }, undefined, {
                    [this.name]: 6,
                });
                ie -= i2 - 1;
                continue;
            }
            /**
             * 合併 東南西北
             */
            if (DIRECTIONS_REGEXP.test(w1.w)) {
                if (DIRECTIONS_REGEXP.test(w2.w)) {
                    ({
                        nw_cache,
                        nw_cache_exists,
                    } = self._getWordCache(nw, nw_cache, nw_cache_exists));
                    let mw = this.createToken({
                        p: POSTAG.D_F,
                        ...nw_cache,
                        w: nw,
                        m: [w1, w2],
                    });
                    mw.p = mw.p | POSTAG.D_F;
                    this.sliceToken(words, i, 2, mw, true, {
                        [this.name]: 8,
                    });
                    ie--;
                    continue;
                }
            }
            // 移到下一个词
            i++;
        }
        // 针对组合数字后无法识别新组合的数字问题，需要重新扫描一次
        return is_not_first === true ? words : this.doOptimize(words, true);
    }
}
exports.DictOptimizer = DictOptimizer;
exports.init = DictOptimizer.init.bind(DictOptimizer);
exports.default = DictOptimizer;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiRGljdE9wdGltaXplci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIkRpY3RPcHRpbWl6ZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsWUFBWSxDQUFDOztBQUViLGdDQUE4RTtBQVE5RSxNQUFNLGlCQUFpQixHQUFHLFlBQVksQ0FBQztBQUV2Qzs7OztHQUlHO0FBQ0gsTUFBYSxhQUFjLFNBQVEseUJBQW1CO0lBQXREOztRQUtDLFNBQUksR0FBRyxlQUFlLENBQUM7SUFxWnhCLENBQUM7SUFuWkEsTUFBTTtRQUVMLEtBQUssQ0FBQyxNQUFNLEVBQUUsQ0FBQztRQUNmLElBQUksQ0FBQyxNQUFNLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLENBQUM7UUFDNUMsSUFBSSxDQUFDLE9BQU8sR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQztJQUNwQyxDQUFDO0lBRUQsV0FBVyxDQUFDLEVBQVMsRUFBRSxFQUFTLEVBQUUsRUFDakMsTUFBTSxFQUNOLEtBQUssRUFDTCxFQUFFLEVBQ0YsQ0FBQyxFQUNELFFBQVEsRUFDUixlQUFlLEdBUWY7UUFFQSxJQUFJLElBQWEsQ0FBQztRQUNsQixJQUFJLENBQVMsQ0FBQztRQUVkOztXQUVHO1FBQ0gsSUFBSSxFQUFFLENBQUMsQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDLEVBQ2hCO1lBQ0MsSUFBSSxHQUFHLElBQUksQ0FBQztTQUNaO1FBQ0Q7O1dBRUc7YUFDRSxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxDQUFDLEdBQUcsRUFBRSxDQUFDLENBQUMsQ0FBQyxFQUMxQjtZQUNDLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxNQUFNLENBQUMsR0FBRyxFQUN2QjtnQkFDQyxJQUFJLEdBQUcsSUFBSSxDQUFDO2FBQ1o7U0FDRDtRQUNEOztXQUVHO2FBQ0UsSUFBSSxFQUFFLENBQUMsQ0FBQyxJQUFJLE9BQU8sRUFBRSxDQUFDLENBQUMsSUFB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Q0FBdUMsQ0FBQztBQUVqRyxrQkFBZSxhQUFhLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIHN0cmljdCc7XG5cbmltcG9ydCB7IFN1YlNNb2R1bGUsIFN1YlNNb2R1bGVPcHRpbWl6ZXIsIElTdWJPcHRpbWl6ZXJDcmVhdGUgfSBmcm9tICcuLi9tb2QnO1xuaW1wb3J0IHsgU2VnbWVudCwgSVdvcmQsIElESUNUIH0gZnJvbSAnLi4vU2VnbWVudCc7XG4vLyBAdHMtaWdub3JlXG5pbXBvcnQgeyBVU3RyaW5nIH0gZnJvbSAndW5pLXN0cmluZyc7XG5pbXBvcnQgSVBPU1RBRyBmcm9tICcuLi9QT1NUQUcnO1xuaW1wb3J0IHsgZGVidWcsIElXb3JkRGVidWcgfSBmcm9tICcuLi91dGlsJztcbmltcG9ydCB7IHpoUmVnRXhwIH0gZnJvbSAncmVnZXhwLWNqayc7XG5cbmNvbnN0IERJUkVDVElPTlNfUkVHRVhQID0gL15b5p2x6KW/5Y2X5YyX5LicXSskLztcblxuLyoqXG4gKiDor43lhbjkvJjljJbmqKHlnZdcbiAqXG4gKiBAYXV0aG9yIOiAgembtzxsZWl6b25nbWluQGdtYWlsLmNvbT5cbiAqL1xuZXhwb3J0IGNsYXNzIERpY3RPcHRpbWl6ZXIgZXh0ZW5kcyBTdWJTTW9kdWxlT3B0aW1pemVyXG57XG5cblx0cHJvdGVjdGVkIF9UQUJMRTogSURJQ1Q8SVdvcmQ+O1xuXG5cdG5hbWUgPSAnRGljdE9wdGltaXplcic7XG5cblx0X2NhY2hlKClcblx0e1xuXHRcdHN1cGVyLl9jYWNoZSgpO1xuXHRcdHRoaXMuX1RBQkxFID0gdGhpcy5zZWdtZW50LmdldERpY3QoJ1RBQkxFJyk7XG5cdFx0dGhpcy5fUE9TVEFHID0gdGhpcy5zZWdtZW50LlBPU1RBRztcblx0fVxuXG5cdGlzTWVyZ2VhYmxlKHcxOiBJV29yZCwgdzI6IElXb3JkLCB7XG5cdFx0UE9TVEFHLFxuXHRcdFRBQkxFLFxuXHRcdG53LFxuXHRcdGksXG5cdFx0bndfY2FjaGUsXG5cdFx0bndfY2FjaGVfZXhpc3RzLFxuXHR9OiB7XG5cdFx0UE9TVEFHOiB0eXBlb2YgSVBPU1RBRyxcblx0XHRUQUJMRTogSURJQ1QsXG5cdFx0bnc6IHN0cmluZyxcblx0XHRpOiBudW1iZXIsXG5cdFx0bndfY2FjaGU6IElXb3JkLFxuXHRcdG53X2NhY2hlX2V4aXN0czogYm9vbGVhbixcblx0fSk6IGJvb2xlYW5cblx0e1xuXHRcdGxldCBib29sOiBib29sZWFuO1xuXHRcdGxldCBtOiBudW1iZXI7XG5cblx0XHQvKipcblx0XHQgKiDljp/lp4vliKTmlrfmqKHlvI9cblx0XHQgKi9cblx0XHRpZiAodzEucCA9PSB3Mi5wKVxuXHRcdHtcblx0XHRcdGJvb2wgPSB0cnVlO1xuXHRcdH1cblx0XHQvKipcblx0XHQgKiDkuI3norrlrprmspLmnIlCVUcg5L2G5Y6f5aeL5qih5byP5bey57aT5LiN5ZCI6ZyA5rGCIOWboOeCuuWWruS4gOmgheebruWkmuWAi+ipnuaAp1xuXHRcdCAqL1xuXHRcdGVsc2UgaWYgKG0gPSAodzEucCAmIHcyLnApKVxuXHRcdHtcblx0XHRcdGlmICgxIHx8IG0gJiBQT1NUQUcuRF9OKVxuXHRcdFx0e1xuXHRcdFx0XHRib29sID0gdHJ1ZTtcblx0XHRcdH1cblx0XHR9XG5cdFx0LyoqXG5cdFx0ICog5YWB6Kix5L6L5aaCIOW5viArIO+8hVxuXHRcdCAqL1xuXHRcdGVsc2UgaWYgKHcxLnAgJiYgdHlwZW9mIHcyLnAgPT0gJ3VuZGVmaW5lZCcpXG5cdFx0e1xuXHRcdFx0Ym9vbCA9IHRydWU7XG5cdFx0fVxuXHRcdGVsc2UgaWYgKHcxLnAgJiBQT1NUQUcuRF9EICYmIHcyLnAgJiBQT1NUQUcuRF9WKVxuXHRcdHtcblx0XHRcdCh7XG5cdFx0XHRcdG53X2NhY2hlLFxuXHRcdFx0XHRud19jYWNoZV9leGlzdHMsXG5cdFx0XHR9ID0gdGhpcy5fZ2V0V29yZENhY2hlKG53LCBud19jYWNoZSwgbndfY2FjaGVfZXhpc3RzKSk7XG5cblx0XHRcdGxldCBtdyA9IG53X2NhY2hlO1xuXG5cdFx0XHRpZiAobXcgJiYgKG13LnAgJiBQT1NUQUcuRF9EIHx8IG13LnAgJiBQT1NUQUcuRF9WKSlcblx0XHRcdHtcblx0XHRcdFx0Ym9vbCA9IHRydWU7XG5cdFx0XHR9XG5cdFx0fVxuXG5cdFx0cmV0dXJuIGJvb2xcblx0XHRcdCYmIHRoaXMuX2dldFdvcmRDYWNoZShudywgbndfY2FjaGUsIG53X2NhY2hlX2V4aXN0cykubndfY2FjaGVfZXhpc3RzO1xuXHR9XG5cblx0X2dldFdvcmRDYWNoZShudzogc3RyaW5nLCBud19jYWNoZTogSVdvcmQsIG53X2NhY2hlX2V4aXN0czogYm9vbGVhbilcblx0e1xuXHRcdGlmICh0eXBlb2YgbndfY2FjaGVfZXhpc3RzID09PSAndW5kZWZpbmVkJylcblx0XHR7XG5cdFx0XHRjb25zdCBUQUJMRSA9IHRoaXMuX1RBQkxFO1xuXG5cdFx0XHRud19jYWNoZSA9IG53X2NhY2hlIHx8IFRBQkxFW253XTtcblx0XHRcdG53X2NhY2hlX2V4aXN0cyA9ICEhbndfY2FjaGU7XG5cdFx0fVxuXG5cdFx0cmV0dXJuIHtcblx0XHRcdG53LFxuXHRcdFx0bndfY2FjaGUsXG5cdFx0XHRud19jYWNoZV9leGlzdHMsXG5cdFx0fVxuXHR9XG5cblx0LyoqXG5cdCAqIOivjeWFuOS8mOWMllxuXHQgKlxuXHQgKiBAcGFyYW0ge2FycmF5fSB3b3JkcyDljZXor43mlbDnu4Rcblx0ICogQHBhcmFtIHtib29sfSBpc19ub3RfZmlyc3Qg5piv5ZCm5Li6566h55CG5Zmo6LCD55So55qEXG5cdCAqIEByZXR1cm4ge2FycmF5fVxuXHQgKi9cblx0ZG9PcHRpbWl6ZSh3b3JkczogSVdvcmRbXSwgaXNfbm90X2ZpcnN0OiBib29sZWFuKTogSVdvcmRbXVxuXHR7XG5cdFx0Ly9kZWJ1Zyh3b3Jkcyk7XG5cdFx0aWYgKHR5cGVvZiBpc19ub3RfZmlyc3QgPT0gJ3VuZGVmaW5lZCcpXG5cdFx0e1xuXHRcdFx0aXNfbm90X2ZpcnN0ID0gZmFsc2U7XG5cdFx0fVxuXHRcdC8vIOWQiOW5tuebuOmCu+eahOiDvee7hOaIkOS4gOS4quWNleivjeeahOS4pOS4quivjVxuXHRcdGNvbnN0IFRBQkxFID0gdGhpcy5fVEFCTEU7XG5cdFx0Y29uc3QgUE9TVEFHID0gdGhpcy5fUE9TVEFHO1xuXHRcdGNvbnN0IHNlbGYgPSB0aGlzO1xuXG5cdFx0bGV0IGkgPSAwO1xuXHRcdGxldCBpZSA9IHdvcmRzLmxlbmd0aCAtIDE7XG5cdFx0d2hpbGUgKGkgPCBpZSlcblx0XHR7XG5cdFx0XHRsZXQgdzEgPSB3b3Jkc1tpXTtcblx0XHRcdGxldCB3MiA9IHdvcmRzW2kgKyAxXTtcblx0XHRcdC8vZGVidWcodzEudyArICcsICcgKyB3Mi53KTtcblxuXHRcdFx0Ly8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG5cdFx0XHRsZXQgbnc6IHN0cmluZyA9IHcxLncgKyB3Mi53O1xuXG5cdFx0XHRsZXQgbndfY2FjaGU6IElXb3JkO1xuXHRcdFx0bGV0IG53X2NhY2hlX2V4aXN0czogYm9vbGVhbjtcblxuXHRcdFx0LyoqXG5cdFx0XHQgKiDlvaLlrrnor40gKyDliqnor40gPSDlvaLlrrnor43vvIzlpoLvvJog5LiN5ZCMICsg55qEID0g5LiN5ZCM55qEXG5cdFx0XHQgKi9cblx0XHRcdGlmICh3MS53ICE9ICfkuoYnXG5cdFx0XHRcdCYmICh3MS5wICYgUE9TVEFHLkRfQSlcblx0XHRcdFx0JiYgKHcyLnAgJiBQT1NUQUcuRF9VKVxuXHRcdFx0KVxuXHRcdFx0e1xuXHRcdFx0XHRsZXQgcCA9IFBPU1RBRy5EX0E7XG5cdFx0XHRcdGxldCBmOiBudW1iZXI7XG5cblx0XHRcdFx0KHtcblx0XHRcdFx0XHRud19jYWNoZSxcblx0XHRcdFx0XHRud19jYWNoZV9leGlzdHMsXG5cdFx0XHRcdH0gPSBzZWxmLl9nZXRXb3JkQ2FjaGUobncsIG53X2NhY2hlLCBud19jYWNoZV9leGlzdHMpKTtcblxuXHRcdFx0XHRsZXQgbXcgPSBud19jYWNoZTtcblxuXHRcdFx0XHRpZiAoIW13IHx8IChtdy5wICYgUE9TVEFHLkRfQSkpXG5cdFx0XHRcdHtcblx0XHRcdFx0XHRpZiAobXcgJiYgKG13LnAgJiBQT1NUQUcuRF9BKSlcblx0XHRcdFx0XHR7XG5cdFx0XHRcdFx0XHRwID0gbXcucDtcblx0XHRcdFx0XHRcdGYgPSBtdy5mO1xuXHRcdFx0XHRcdH1cblx0XHRcdFx0XHRlbHNlIGlmICh3MS5wICYgUE9TVEFHLkJBRClcblx0XHRcdFx0XHR7XG5cdFx0XHRcdFx0XHRwID0gUE9TVEFHLkRfQSArIFBPU1RBRy5CQUQ7XG5cdFx0XHRcdFx0fVxuXG5cdFx0XHRcdFx0dGhpcy5zbGljZVRva2VuKHdvcmRzLCBpLCAyLCB7XG5cdFx0XHRcdFx0XHR3OiBudyxcblx0XHRcdFx0XHRcdC8vcDogKChudyBpbiBUQUJMRSAmJiBUQUJMRVtud10ucCAmIFBPU1RBRy5EX0EpID8gVEFCTEVbbnddLnAgOiBQT1NUQUcuRF9BKSxcblx0XHRcdFx0XHRcdHAsXG5cdFx0XHRcdFx0XHRmLFxuXHRcdFx0XHRcdFx0bTogW3cxLCB3Ml0sXG5cdFx0XHRcdFx0fSwgdW5kZWZpbmVkLCB7XG5cdFx0XHRcdFx0XHRbdGhpcy5uYW1lXTogMSxcblx0XHRcdFx0XHR9KTtcblx0XHRcdFx0XHRpZS0tO1xuXHRcdFx0XHRcdGNvbnRpbnVlO1xuXHRcdFx0XHR9XG5cdFx0XHR9XG5cblx0XHRcdC8qKlxuXHRcdFx0ICog5b2i5a656KmeICsg5ZCN6KmeID0g5ZCN6KmeXG5cdFx0XHQgKi9cblx0XHRcdGlmICgodzEucCAmIFBPU1RBRy5EX0EpXG5cdFx0XHRcdCYmICh3Mi5wICYgUE9TVEFHLkRfTilcblx0XHRcdClcblx0XHRcdHtcblx0XHRcdFx0KHtcblx0XHRcdFx0XHRud19jYWNoZSxcblx0XHRcdFx0XHRud19jYWNoZV9leGlzdHMsXG5cdFx0XHRcdH0gPSBzZWxmLl9nZXRXb3JkQ2FjaGUobncsIG53X2NhY2hlLCBud19jYWNoZV9leGlzdHMpKTtcblxuXHRcdFx0XHRpZiAobndfY2FjaGVfZXhpc3RzKVxuXHRcdFx0XHR7XG5cdFx0XHRcdFx0bGV0IG13ID0gbndfY2FjaGU7XG5cblx0XHRcdFx0XHRpZiAobXcucCAmIFBPU1RBRy5EX04pXG5cdFx0XHRcdFx0e1xuXHRcdFx0XHRcdFx0dGhpcy5zbGljZVRva2VuKHdvcmRzLCBpLCAyLCB7XG5cdFx0XHRcdFx0XHRcdHc6IG53LFxuXHRcdFx0XHRcdFx0XHRwOiBtdy5wLFxuXHRcdFx0XHRcdFx0XHRmOiBtdy5mLFxuXHRcdFx0XHRcdFx0XHRtOiBbdzEsIHcyXSxcblx0XHRcdFx0XHRcdH0sIHVuZGVmaW5lZCwge1xuXHRcdFx0XHRcdFx0XHRbdGhpcy5uYW1lXTogNyxcblx0XHRcdFx0XHRcdH0pO1xuXHRcdFx0XHRcdFx0aWUtLTtcblx0XHRcdFx0XHRcdGNvbnRpbnVlO1xuXHRcdFx0XHRcdH1cblx0XHRcdFx0fVxuXHRcdFx0fVxuXG5cdFx0XHQvLyDog73nu4TmiJDkuIDkuKrmlrDor43nmoQo6K+N5oCn5b+F6aG755u45ZCMKVxuXG5cdFx0XHRpZiAodGhpcy5pc01lcmdlYWJsZSh3MSwgdzIsIHtcblx0XHRcdFx0bncsXG5cdFx0XHRcdFBPU1RBRyxcblx0XHRcdFx0VEFCTEUsXG5cdFx0XHRcdGksXG5cdFx0XHRcdG53X2NhY2hlLFxuXHRcdFx0XHRud19jYWNoZV9leGlzdHMsXG5cdFx0XHR9KSlcblx0XHRcdC8vaWYgKHcxLnAgPT0gdzIucCAmJiBudyBpbiBUQUJMRSlcblx0XHRcdHtcblx0XHRcdFx0KHtcblx0XHRcdFx0XHRud19jYWNoZSxcblx0XHRcdFx0XHRud19jYWNoZV9leGlzdHMsXG5cdFx0XHRcdH0gPSBzZWxmLl9nZXRXb3JkQ2FjaGUobncsIG53X2NhY2hlLCBud19jYWNoZV9leGlzdHMpKTtcblxuXHRcdFx0XHRsZXQgbXcgPSBud19jYWNoZTtcblxuXHRcdFx0XHR0aGlzLnNsaWNlVG9rZW4od29yZHMsIGksIDIsIHtcblx0XHRcdFx0XHR3OiBudyxcblx0XHRcdFx0XHRwOiBtdy5wLFxuXHRcdFx0XHRcdGY6IG13LmYsXG5cdFx0XHRcdFx0bTogW3cxLCB3Ml0sXG5cdFx0XHRcdH0sIHVuZGVmaW5lZCwge1xuXHRcdFx0XHRcdFt0aGlzLm5hbWVdOiAyLFxuXHRcdFx0XHR9KTtcblx0XHRcdFx0aWUtLTtcblx0XHRcdFx0Y29udGludWU7XG5cdFx0XHR9XG5cblx0XHRcdC8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG5cdFx0XHQvLyDmlbDor43nu4TlkIhcblx0XHRcdGlmICgodzEucCAmIFBPU1RBRy5BX00pKVxuXHRcdFx0e1xuXHRcdFx0XHQvL2RlYnVnKHcyLncgKyAnICcgKyAodzIucCAmIFBPU1RBRy5BX00pKTtcblx0XHRcdFx0Ly8g55m+5YiG5q+U5pWw5a2XIOWmgiAxMCXvvIzmiJbogIXkuIvkuIDkuKror43kuZ/mmK/mlbDor43vvIzliJnlkIjlubZcblx0XHRcdFx0aWYgKChcblx0XHRcdFx0XHR3Mi5wICYgUE9TVEFHLkFfTVxuXHRcdFx0XHRcdCYmICEvXuesrC8udGVzdCh3Mi53KVxuXHRcdFx0XHQpIHx8IHcyLncgPT0gJyUnIHx8IHcyLncgPT0gJ++8hScpXG5cdFx0XHRcdHtcblx0XHRcdFx0XHR0aGlzLnNsaWNlVG9rZW4od29yZHMsIGksIDIsIHtcblx0XHRcdFx0XHRcdHc6IHcxLncgKyB3Mi53LFxuXHRcdFx0XHRcdFx0cDogUE9TVEFHLkFfTSxcblx0XHRcdFx0XHRcdG06IFt3MSwgdzJdLFxuXHRcdFx0XHRcdH0sIHVuZGVmaW5lZCwge1xuXHRcdFx0XHRcdFx0W3RoaXMubmFtZV06IDMsXG5cdFx0XHRcdFx0fSk7XG5cdFx0XHRcdFx0aWUtLTtcblx0XHRcdFx0XHRjb250aW51ZTtcblx0XHRcdFx0fVxuXHRcdFx0XHQvLyDmlbDor40gKyDph4/or43vvIzlkIjlubbjgILlpoLvvJogMTAw5LiqXG5cdFx0XHRcdGlmICgodzIucCAmIFBPU1RBRy5BX1EpKVxuXHRcdFx0XHR7XG5cdFx0XHRcdFx0Ly8g5pWw6YeP6K+NXG5cdFx0XHRcdFx0bGV0IHAgPSBQT1NUQUcuRF9NUTtcblx0XHRcdFx0XHRsZXQgbnc6IHN0cmluZyA9IHcxLncgKyB3Mi53O1xuXG5cdFx0XHRcdFx0KHtcblx0XHRcdFx0XHRcdG53X2NhY2hlLFxuXHRcdFx0XHRcdFx0bndfY2FjaGVfZXhpc3RzLFxuXHRcdFx0XHRcdH0gPSBzZWxmLl9nZXRXb3JkQ2FjaGUobncsIG53X2NhY2hlLCBud19jYWNoZV9leGlzdHMpKTtcblxuXHRcdFx0XHRcdGlmIChud19jYWNoZSlcblx0XHRcdFx0XHR7XG5cdFx0XHRcdFx0XHRwID0gbndfY2FjaGUucCB8IFBPU1RBRy5EX01RO1xuXHRcdFx0XHRcdH1cblx0XHRcdFx0XHRlbHNlXG5cdFx0XHRcdFx0e1xuXHRcdFx0XHRcdFx0aWYgKHcyLnAgJiBQT1NUQUcuRF9UKVxuXHRcdFx0XHRcdFx0e1xuXHRcdFx0XHRcdFx0XHRwID0gcCB8IFBPU1RBRy5EX1Q7XG5cdFx0XHRcdFx0XHR9XG5cdFx0XHRcdFx0XHRpZiAodzIucCAmIFBPU1RBRy5EX04pXG5cdFx0XHRcdFx0XHR7XG5cdFx0XHRcdFx0XHRcdHAgPSBwIHwgUE9TVEFHLkRfTjtcblx0XHRcdFx0XHRcdH1cblx0XHRcdFx0XHRcdGlmICh3Mi5wICYgUE9TVEFHLkRfVilcblx0XHRcdFx0XHRcdHtcblx0XHRcdFx0XHRcdFx0cCA9IHAgfCBQT1NUQUcuRF9WO1xuXHRcdFx0XHRcdFx0fVxuXHRcdFx0XHRcdH1cblxuXHRcdFx0XHRcdHRoaXMuc2xpY2VUb2tlbih3b3JkcywgaSwgMiwge1xuXHRcdFx0XHRcdFx0dzogbncsXG5cdFx0XHRcdFx0XHRwLFxuXHRcdFx0XHRcdFx0bTogW3cxLCB3Ml0sXG5cdFx0XHRcdFx0fSwgdW5kZWZpbmVkLCB7XG5cdFx0XHRcdFx0XHRbdGhpcy5uYW1lXTogNCxcblx0XHRcdFx0XHR9KTtcblx0XHRcdFx0XHRpZS0tO1xuXHRcdFx0XHRcdGNvbnRpbnVlO1xuXHRcdFx0XHR9XG5cdFx0XHRcdC8vIOW4puWwj+aVsOeCueeahOaVsOWtlyDvvIzlpoIg4oCcMyAuIDE04oCd77yM5oiW6ICFIOKAnOWNgeS6lOeCueS4ieKAnVxuXHRcdFx0XHQvLyDmlbDor40gKyBcIuWIhuS5i1wiICsg5pWw6K+N77yM5aaC4oCc5LqU5Y2B5YiG5LmL5LiA4oCdXG5cdFx0XHRcdGxldCB3MyA9IHdvcmRzW2kgKyAyXTtcblx0XHRcdFx0aWYgKHczICYmICh3My5wICYgUE9TVEFHLkFfTSkpXG5cdFx0XHRcdHtcblx0XHRcdFx0XHRpZiAodzIudyA9PSAnLidcblx0XHRcdFx0XHRcdHx8IHcyLncgPT0gJ+eCuSdcblx0XHRcdFx0XHRcdHx8IHcyLncgPT0gJ+m7nidcblx0XHRcdFx0XHRcdHx8IHcyLncgPT0gJ+WIhuS5iydcblx0XHRcdFx0XHQpXG5cdFx0XHRcdFx0e1xuXHRcdFx0XHRcdFx0dGhpcy5zbGljZVRva2VuKHdvcmRzLCBpLCAzLCB7XG5cdFx0XHRcdFx0XHRcdHc6IHcxLncgKyB3Mi53ICsgdzMudyxcblx0XHRcdFx0XHRcdFx0cDogUE9TVEFHLkFfTSxcblx0XHRcdFx0XHRcdFx0bTogW3cxLCB3MiwgdzNdLFxuXHRcdFx0XHRcdFx0fSwgdW5kZWZpbmVkLCB7XG5cdFx0XHRcdFx0XHRcdFt0aGlzLm5hbWVdOiA1LFxuXHRcdFx0XHRcdFx0fSk7XG5cdFx0XHRcdFx0XHRpZSAtPSAyO1xuXHRcdFx0XHRcdFx0Y29udGludWU7XG5cdFx0XHRcdFx0fVxuXG5cdFx0XHRcdFx0LyoqXG5cdFx0XHRcdFx0ICog5pSv5o+0IGDmnIDlpJrlrrnntI01OSwwMDDlgIvkuros5oiWNS456JCs5Lq6LOWGjeWkmuWwseS4jeihjOS6hi7pgJnmmK/nkrDoqZXnmoTntZDoq5YuYFxuXHRcdFx0XHRcdCAqL1xuXHRcdFx0XHRcdGlmICh3Mi53ID09ICcsJylcblx0XHRcdFx0XHR7XG5cdFx0XHRcdFx0XHRsZXQgX3IxID0gL15bXFxk77yQLe+8mV0rJC87XG5cdFx0XHRcdFx0XHRsZXQgX3IyID0gL14oPzooPzpbXFxk77yQLe+8mV0rKT8oPzpcXC5bXFxk77yQLe+8mV0rKXwoPzpbXFxk77yQLe+8mV0rKSkkLztcblxuXHRcdFx0XHRcdFx0aWYgKF9yMS50ZXN0KHcxLncpICYmIF9yMi50ZXN0KHczLncpKVxuXHRcdFx0XHRcdFx0e1xuXHRcdFx0XHRcdFx0XHR0aGlzLnNsaWNlVG9rZW4od29yZHMsIGksIDMsIHtcblx0XHRcdFx0XHRcdFx0XHR3OiB3MS53ICsgdzIudyArIHczLncsXG5cdFx0XHRcdFx0XHRcdFx0cDogUE9TVEFHLkFfTSxcblx0XHRcdFx0XHRcdFx0XHRtOiBbdzEsIHcyLCB3M10sXG5cdFx0XHRcdFx0XHRcdH0sIHVuZGVmaW5lZCwge1xuXHRcdFx0XHRcdFx0XHRcdFt0aGlzLm5hbWVdOiA2LFxuXHRcdFx0XHRcdFx0XHR9KTtcblx0XHRcdFx0XHRcdFx0aWUgLT0gMjtcblx0XHRcdFx0XHRcdFx0Y29udGludWU7XG5cdFx0XHRcdFx0XHR9XG5cdFx0XHRcdFx0fVxuXHRcdFx0XHR9XG5cdFx0XHR9XG5cblx0XHRcdC8vIOS/ruatoyDigJzljYHkupTngrnkupTlhavigJ3pl67pophcblx0XHRcdGlmICgodzEucCAmIFBPU1RBRy5EX01RKSAmJiBbJ+m7nicsICfngrknXS5pbmNsdWRlcyh3MS53LnN1YnN0cigtMSkpICYmIHcyLnAgJiBQT1NUQUcuQV9NKVxuXHRcdFx0e1xuXHRcdFx0XHQvL2RlYnVnKHcxLCB3Mik7XG5cdFx0XHRcdGxldCBpMiA9IDI7XG5cdFx0XHRcdGxldCB3NHcgPSAnJztcblx0XHRcdFx0Zm9yIChsZXQgaiA9IGkgKyBpMjsgaiA8IGllOyBqKyspXG5cdFx0XHRcdHtcblx0XHRcdFx0XHRsZXQgdzMgPSB3b3Jkc1tqXTtcblx0XHRcdFx0XHRpZiAoKHczLnAgJiBQT1NUQUcuQV9NKSA+IDApXG5cdFx0XHRcdFx0e1xuXHRcdFx0XHRcdFx0dzR3ICs9IHczLnc7XG5cdFx0XHRcdFx0XHRpMisrO1xuXHRcdFx0XHRcdH1cblx0XHRcdFx0XHRlbHNlXG5cdFx0XHRcdFx0e1xuXHRcdFx0XHRcdFx0YnJlYWs7XG5cdFx0XHRcdFx0fVxuXHRcdFx0XHR9XG5cdFx0XHRcdHRoaXMuc2xpY2VUb2tlbih3b3JkcywgaSwgaTIsIHtcblx0XHRcdFx0XHR3OiB3MS53ICsgdzIudyArIHc0dyxcblx0XHRcdFx0XHRwOiBQT1NUQUcuRF9NUSwgLy8g5pWw6YeP6K+NXG5cdFx0XHRcdFx0bTogW3cxLCB3MiwgdzR3XSxcblx0XHRcdFx0fSwgdW5kZWZpbmVkLCB7XG5cdFx0XHRcdFx0W3RoaXMubmFtZV06IDYsXG5cdFx0XHRcdH0pO1xuXHRcdFx0XHRpZSAtPSBpMiAtIDE7XG5cdFx0XHRcdGNvbnRpbnVlO1xuXHRcdFx0fVxuXG5cdFx0XHQvKipcblx0XHRcdCAqIOWQiOS9tSDmnbHljZfopb/ljJdcblx0XHRcdCAqL1xuXHRcdFx0aWYgKERJUkVDVElPTlNfUkVHRVhQLnRlc3QodzEudykpXG5cdFx0XHR7XG5cdFx0XHRcdGlmIChESVJFQ1RJT05TX1JFR0VYUC50ZXN0KHcyLncpKVxuXHRcdFx0XHR7XG5cdFx0XHRcdFx0KHtcblx0XHRcdFx0XHRcdG53X2NhY2hlLFxuXHRcdFx0XHRcdFx0bndfY2FjaGVfZXhpc3RzLFxuXHRcdFx0XHRcdH0gPSBzZWxmLl9nZXRXb3JkQ2FjaGUobncsIG53X2NhY2hlLCBud19jYWNoZV9leGlzdHMpKTtcblxuXHRcdFx0XHRcdGxldCBtdzogSVdvcmREZWJ1ZyA9IHRoaXMuY3JlYXRlVG9rZW4oe1xuXHRcdFx0XHRcdFx0cDogUE9TVEFHLkRfRixcblx0XHRcdFx0XHRcdC4uLm53X2NhY2hlLFxuXHRcdFx0XHRcdFx0dzogbncsXG5cdFx0XHRcdFx0XHRtOiBbdzEsIHcyXSxcblx0XHRcdFx0XHR9KTtcblxuXHRcdFx0XHRcdG13LnAgPSBtdy5wIHwgUE9TVEFHLkRfRjtcblxuXHRcdFx0XHRcdHRoaXMuc2xpY2VUb2tlbih3b3JkcywgaSwgMiwgbXcsIHRydWUsIHtcblx0XHRcdFx0XHRcdFt0aGlzLm5hbWVdOiA4LFxuXHRcdFx0XHRcdH0pO1xuXG5cdFx0XHRcdFx0aWUtLTtcblx0XHRcdFx0XHRjb250aW51ZTtcblx0XHRcdFx0fVxuXHRcdFx0fVxuXG5cdFx0XHQvLyDnp7vliLDkuIvkuIDkuKror41cblx0XHRcdGkrKztcblx0XHR9XG5cblx0XHQvLyDpkojlr7nnu4TlkIjmlbDlrZflkI7ml6Dms5Xor4bliKvmlrDnu4TlkIjnmoTmlbDlrZfpl67popjvvIzpnIDopoHph43mlrDmiavmj4/kuIDmrKFcblx0XHRyZXR1cm4gaXNfbm90X2ZpcnN0ID09PSB0cnVlID8gd29yZHMgOiB0aGlzLmRvT3B0aW1pemUod29yZHMsIHRydWUpO1xuXHR9XG5cbn1cblxuZXhwb3J0IGNvbnN0IGluaXQgPSBEaWN0T3B0aW1pemVyLmluaXQuYmluZChEaWN0T3B0aW1pemVyKSBhcyBJU3ViT3B0aW1pemVyQ3JlYXRlPERpY3RPcHRpbWl6ZXI+O1xuXG5leHBvcnQgZGVmYXVsdCBEaWN0T3B0aW1pemVyO1xuIl19